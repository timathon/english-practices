<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit 2: You Can Make A Difference - Sentence Builder</title>
    <style>
        :root {
            --primary: #58cc02; /* Duolingo Green */
            --primary-dark: #46a302;
            --danger: #ff4b4b;
            --danger-dark: #d33131;
            --warning: #ffc800;
            --warning-dark: #e5b400;
            --secondary: #1cb0f6;
            --secondary-dark: #1185ba;
            --neutral: #e5e5e5;
            --text: #4b4b4b;
            --white: #ffffff;
            --bg: #f7f7f7;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        #app {
            width: 100%;
            max-width: 600px;
            background: var(--white);
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 600px) {
            #app {
                min-height: 90vh;
                border-radius: 20px;
                overflow: hidden;
            }
        }

        /* --- Screens --- */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            flex-grow: 1;
        }

        .screen.active {
            display: flex;
        }

        /* --- Home Screen --- */
        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--secondary);
            margin: 0;
            font-size: 1.8rem;
        }

        h2 {
            font-size: 1.1rem;
            color: #777;
            margin-top: 5px;
        }

        .challenge-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .challenge-card {
            background: var(--white);
            border: 2px solid var(--neutral);
            border-bottom: 4px solid var(--neutral);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.1s, border-color 0.1s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .challenge-card:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }

        .challenge-card:hover {
            background-color: #fafafa;
            border-color: var(--secondary);
        }

        .challenge-icon {
            font-size: 2rem;
            margin-right: 15px;
        }

        .challenge-info h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .challenge-info p {
            margin: 5px 0 0;
            font-size: 0.9rem;
            color: #888;
        }

        /* --- Game Screen --- */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .close-btn {
            font-size: 1.5rem;
            cursor: pointer;
            color: #ccc;
            background: none;
            border: none;
        }

        .progress-container {
            flex-grow: 1;
            margin: 0 15px;
            height: 16px;
            background-color: var(--neutral);
            border-radius: 8px;
            display: flex;
            overflow: hidden;
        }

        .progress-segment {
            flex-grow: 1;
            border-right: 1px solid var(--white);
        }
        .progress-segment:last-child { border-right: none; }
        .progress-segment.green { background-color: var(--primary); }
        .progress-segment.yellow { background-color: var(--warning); } /* Partial credit */
        .progress-segment.red { background-color: var(--danger); }

        .question-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        /* Target Sentence (Chinese) */
        .target-sentence {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 10px;
            font-weight: bold;
            display: block; 
            text-align: center;
        }

        .prompt-text {
            font-size: 0.9rem;
            color: #999;
            margin-bottom: 5px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Answer Area (Droppable) */
        .answer-area {
            min-height: 70px;
            background-color: #fff;
            border-top: 2px solid var(--neutral);
            border-bottom: 2px solid var(--neutral);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px 10px;
            align-items: center;
            justify-content: flex-start; /* Left align for sentence flow */
        }

        .answer-placeholder {
            color: #ccc;
            font-style: italic;
            width: 100%;
            text-align: center;
            pointer-events: none;
        }

        /* Word Pool */
        .word-pool {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Word Buttons */
        .word-btn {
            background: var(--white);
            border: 2px solid var(--neutral);
            border-bottom: 4px solid var(--neutral);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 1.1rem;
            cursor: pointer;
            color: var(--text);
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.1;
        }

        .word-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }

        .word-btn.selected {
            background: var(--neutral);
            color: transparent;
            border-color: transparent;
            pointer-events: none;
            box-shadow: none;
        }
        
        /* IPA Style in Pool */
        .ipa-text {
            font-size: 0.75rem;
            color: #999;
            margin-top: 2px;
            font-family: 'Arial Unicode MS', 'Lucida Sans Unicode', sans-serif;
        }

        /* Answer Buttons (No IPA) */
        .word-btn-answer {
            background: var(--white);
            border: 2px solid var(--secondary);
            border-bottom: 4px solid var(--secondary-dark);
            border-radius: 12px;
            padding: 10px 15px;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--secondary-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- Footer Actions --- */
        .footer-action {
            padding-top: 20px;
            border-top: 2px solid var(--neutral);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-row {
            display: flex;
            gap: 10px;
        }

        .hint-btn {
            flex: 1;
            padding: 15px;
            border-radius: 16px;
            background: var(--white);
            border: 2px solid var(--neutral);
            border-bottom: 4px solid var(--neutral);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hint-btn:active { transform: translateY(2px); border-bottom-width: 2px; }

        .check-btn {
            flex: 4;
            padding: 15px;
            border-radius: 16px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            background-color: var(--primary);
            border: none;
            border-bottom: 5px solid var(--primary-dark);
            cursor: pointer;
            text-transform: uppercase;
        }

        .check-btn:active {
            transform: translateY(2px);
            border-bottom-width: 3px;
        }

        .check-btn.wrong {
            background-color: var(--danger);
            border-bottom-color: var(--danger-dark);
            animation: shake 0.5s;
        }

        .check-btn.correct {
            background-color: var(--primary);
            animation: bounce 0.5s;
        }

        .check-btn:disabled {
            background-color: var(--neutral);
            border-bottom-color: #ccc;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        /* --- Feedback Overlay --- */
        .feedback {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border-radius: 12px;
            text-align: left;
        }
        .feedback.show { display: block; }
        .feedback.correct { background-color: #d7ffb8; color: #58a700; }
        .feedback.wrong { background-color: #ffdfe0; color: #ea2b2b; }

        .hint-display {
            display: none;
            background-color: #fff8e1;
            border: 1px solid #ffecb3;
            color: #8a6d3b;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 0.95rem;
        }

        .feedback h3 { margin: 0 0 5px 0; }
        
        /* --- History Modal --- */
        #history-modal, #mistakes-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            border-radius: 20px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .log-list {
            overflow-y: auto;
            flex-grow: 1;
            border: 1px solid #eee;
            margin-bottom: 15px;
        }
        .log-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .log-item span.score { font-weight: bold; color: var(--primary); }
        .danger-text { color: var(--danger); cursor: pointer; font-size: 0.8rem; text-decoration: underline;}

        /* --- Animations --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }

    </style>
</head>
<body>

<div id="app">
    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
        <header>
            <h1>You Can Make A Difference</h1>
            <h2>Unit 2 Sentence Builder</h2>
        </header>

        <div class="challenge-grid" id="challenge-list">
            <!-- Populated by JS -->
        </div>

        <div style="margin-top: auto; text-align: center; padding-top: 10px; display:flex; flex-direction:column; gap:10px;">
            <button onclick="app.showMistakes()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-weight:bold; font-size:1rem;">View My Mistakes</button>
            <button onclick="app.showHistory()" style="background:none; border:none; color:#ccc; cursor:pointer;">Teacher Dashboard</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div class="top-bar">
            <button class="close-btn" onclick="app.goHome()">âœ•</button>
            <div class="progress-container" id="progress-bar">
                <!-- Segments injected by JS -->
            </div>
        </div>

        <div class="question-area">
            <h2 class="prompt-text">Translate this sentence</h2>
            <div class="target-sentence" id="display-text"></div>
            
            <div id="hint-display" class="hint-display"></div>

            <div class="answer-area" id="answer-area">
                <div class="answer-placeholder">Tap words below to build sentence...</div>
            </div>

            <div class="word-pool" id="word-pool">
                <!-- Word options go here -->
            </div>
        </div>

        <div class="footer-action">
            <div class="feedback" id="feedback-area">
                <h3 id="feedback-title"></h3>
                <p id="feedback-msg"></p>
            </div>
            
            <div class="action-row">
                <button id="hint-btn" class="hint-btn" onclick="app.showHint()" title="Get a hint (Costs 50% points)">ðŸ’¡</button>
                <button id="check-btn" class="check-btn" onclick="app.checkAnswer()" disabled>Check</button>
                <button id="next-btn" class="check-btn" onclick="app.nextQuestion()" style="display:none; background-color: var(--secondary); border-bottom-color: var(--secondary-dark);">Continue</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Session History</h2>
                <button onclick="app.closeHistory()" class="close-btn" style="color:#333">âœ•</button>
            </div>
            <div class="log-list" id="log-list"></div>
            <div style="text-align: right;">
                <span class="danger-text" onclick="app.clearHistory()">Clear History (Teacher Only)</span>
            </div>
        </div>
    </div>

    <!-- Mistakes Modal -->
    <div id="mistakes-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color:var(--danger)">My Mistakes</h2>
                <button onclick="app.closeMistakes()" class="close-btn" style="color:#333">âœ•</button>
            </div>
            <div class="log-list" id="mistakes-list"></div>
            <div style="text-align: right;">
                <span class="danger-text" onclick="app.clearMistakes()">Clear My Mistakes</span>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- DATA: Unit 2 Content --- */
    
    // Simple IPA Dictionary for Unit 2 Vocabulary & Common Words
    const ipaDict = {
        "I": "aÉª", "can": "kÃ¦n", "help": "hÉ›lp", "the": "Ã°É™", "lady": "ËˆleÉªdi", "cross": "krÉ’s", "street": "striËt",
        "He": "hiË", "helps": "hÉ›lps", "woman": "ËˆwÊŠmÉ™n", "go": "gÉ™ÊŠ", "up": "ÊŒp", "stairs": "steÉ™z",
        "We": "wiË", "push": "pÊŠÊƒ", "heavy": "ËˆhÉ›vi", "cart": "kÉ‘Ët",
        "Please": "pliËz", "me": "miË", "pick": "pÉªk", "things": "Î¸ÉªÅ‹z",
        "She": "ÊƒiË", "wants": "wÉ’nts", "to": "tuË", "be": "biË", "a": "É™", "volunteer": "ËŒvÉ’lÉ™nËˆtÉªÉ™", "today": "tÉ™ËˆdeÉª",
        "It": "Éªt", "is": "Éªz", "important": "ÉªmËˆpÉ”ËtÉ™nt", "others": "ËˆÊŒÃ°É™z",
        "picked": "pÉªkt", "rubbish": "ËˆrÊŒbÉªÊƒ", "in": "Éªn", "playground": "ËˆpleÉªgraÊŠnd",
        "Can": "kÃ¦n", "you": "juË", "get": "gÉ›t", "balloons": "bÉ™ËˆluËnz",
        "The": "Ã°É™", "elderly": "ËˆÉ›ldÉ™li", "man": "mÃ¦n", "needs": "niËdz", "our": "ËˆaÊŠÉ™",
        "make": "meÉªk", "difference": "ËˆdÉªfrÉ™ns", "together": "tÉ™ËˆgÉ›Ã°É™",
        "four": "fÉ”Ë", "friends": "frÉ›ndz", "went": "wÉ›nt", "hiking": "ËˆhaÉªkÉªÅ‹", "yesterday": "ËˆjÉ›stÉ™deÉª",
        "Let": "lÉ›t", "us": "ÊŒs", "have": "hÃ¦v", "race": "reÉªs", "top": "tÉ’p",
        "They": "Ã°eÉª", "all": "É”Ël", "hurried": "ËˆhÊŒrÉªd", "hill": "hÉªl",
        "Daming": "Daming", "was": "wÉ’z", "front": "frÊŒnt", "at": "Ã¦t", "first": "fÉœËst",
        "Then": "Ã°É›n", "he": "hiË", "slowed": "slÉ™ÊŠd", "down": "daÊŠn", "along": "É™ËˆlÉ’Å‹", "way": "weÉª",
        "saw": "sÉ”Ë", "some": "sÊŒm", "cans": "kÃ¦nz", "and": "Ã¦nd", "plastic": "ËˆplÃ¦stÉªk", "bottles": "ËˆbÉ’tlz",
        "them": "Ã°É›m", "put": "pÊŠt", "bag": "bÃ¦g",
        "My": "maÉª", "waited": "ËˆweÉªtÉªd", "for": "fÉ”Ë", "long": "lÉ’Å‹", "time": "taÉªm",
        "You": "juË", "are": "É‘Ë", "real": "rÉªÉ™l", "winner": "ËˆwÉªnÉ™",
        "tired": "ËˆtaÉªÉ™d", "but": "bÊŒt", "very": "ËˆvÉ›ri", "happy": "ËˆhÃ¦pi",
        "puppy": "ËˆpÊŒpi", "small": "smÉ”Ël", "playful": "ËˆpleÉªfÊŠl",
        "will": "wÉªl", "someone's": "ËˆsÊŒmwÊŒnz", "eyes": "aÉªz", "one": "wÊŒn", "day": "deÉª",
        "had": "hÃ¦d", "no": "nÉ™ÊŠ", "family": "ËˆfÃ¦mÉªli", "eighty": "ËˆeÉªti",
        "played": "pleÉªd", "ukulele": "ËŒjuËkÉ™ËˆleÉªli", "guitar": "gÉªËˆtÉ‘Ë",
        "sat": "sÃ¦t", "alone": "É™ËˆlÉ™ÊŠn", "lunchtime": "ËˆlÊŒnÊ§taÉªm",
        "gave": "geÉªv", "her": "hÉœË", "half": "hÉ‘Ëf", "of": "É’v", "my": "maÉª", "sandwich": "ËˆsÃ¦nwÉªÊ¤",
        "felt": "fÉ›lt", "full": "fÊŠl", "after": "ËˆÉ‘ËftÉ™", "ate": "É›t",
        "good": "gÊŠd", "share": "ÊƒeÉ™", "with": "wÉªÃ°",
        "not": "nÉ’t", "enough": "ÉªËˆnÊŒf", "band": "bÃ¦nd",
        "Making": "ËˆmeÉªkÉªÅ‹", "new": "njuË", "friend": "frÉ›nd", "wonderful": "ËˆwÊŒndÉ™fÊŠl",
        "Who": "huË", "hero": "ËˆhÉªÉ™rÉ™ÊŠ", "your": "jÉ”Ë", "heart": "hÉ‘Ët",
        "magic": "ËˆmÃ¦Ê¤Éªk", "wanted": "ËˆwÉ’ntÉªd",
        "like": "laÉªk", "shining": "ËˆÊƒaÉªnÉªÅ‹", "star": "stÉ‘Ë",
        "inspires": "ÉªnËˆspaÉªÉ™z", "do": "duË", "part": "pÉ‘Ët",
        "Lei": "Lei", "Feng": "Feng", "forever": "fÉ™ËˆrÉ›vÉ™",
        "should": "ÊƒÊŠd", "learn": "lÉœËn", "from": "frÉ’m", "his": "hÉªz", "spirit": "ËˆspÉªrÉªt",
        "stories": "ËˆstÉ”Ëriz", "moved": "muËvd", "lot": "lÉ’t",
        "shared": "ÊƒeÉ™d", "son": "sÊŒn",
        "Kindness": "ËˆkaÉªndnÉªs", "gives": "gÉªvz", "great": "greÉªt", "power": "ËˆpaÊŠÉ™",
        "clean": "kliËn", "park": "pÉ‘Ëk", "on": "É’n", "Sunday": "ËˆsÊŒndeÉª",
        "care": "keÉ™", "home": "hÉ™ÊŠm",
        "give": "gÉªv", "books": "bÊŠks", "children": "ËˆÊ§ÉªldrÉ™n",
        "tomorrow": "tÉ™ËˆmÉ’rÉ™ÊŠ",
        "What": "wÉ’t", "did": "dÉªd",
        "Non-profit": "nÉ’n-ËˆprÉ’fÉªt", "organisations": "ËŒÉ”ËgÉ™naÉªËˆzeÉªÊƒÉ™nz", "people": "ËˆpiËpl",
        "They": "Ã°eÉª", "protect": "prÉ™ËˆtÉ›kt", "animals": "ËˆÃ¦nÉªmÉ™lz", "nature": "ËˆneÉªÊ§É™",
        "works": "wÉœËks", "world": "wÉœËld", "peace": "piËs", "education": "ËŒÉ›djÊŠËˆkeÉªÊƒÉ™n",
        "How": "haÊŠ", "involved": "ÉªnËˆvÉ’lvd",
        "organise": "ËˆÉ”ËgÉ™naÉªz", "activity": "Ã¦kËˆtÉªvÉªti",
        "please": "pliËz", "this": "Ã°Éªs", "heavy": "ËˆhÉ›vi"
    };

    const noiseWords = ["is", "are", "the", "a", "an", "to", "for", "my", "his", "was", "were", "can", "do", "did"];

    const challenges = [
        {
            id: 'c1',
            title: 'Helping Hands',
            icon: 'ðŸ¤',
            sentences: [
                { en: "I can help the lady cross the street.", cn: "æˆ‘å¯ä»¥å¸®åŠ©é‚£ä½å¥³å£«è¿‡é©¬è·¯ã€‚", hint: "Use 'cross' for going to the other side." },
                { en: "He helps the woman go up the stairs.", cn: "ä»–å¸®åŠ©é‚£ä½å¦‡å¥³ä¸Šæ¥¼æ¢¯ã€‚", hint: "Action: go up." },
                { en: "We can help push the heavy cart.", cn: "æˆ‘ä»¬å¯ä»¥å¸®å¿™æŽ¨è¿™è¾†é‡çš„æ‰‹æŽ¨è½¦ã€‚", hint: "Use 'push'." },
                { en: "Please help me pick the things up.", cn: "è¯·å¸®æˆ‘æŠŠä¸œè¥¿æ¡èµ·æ¥ã€‚", hint: "Phrase: pick ... up." },
                { en: "She wants to be a volunteer today.", cn: "å¥¹ä»Šå¤©æƒ³æˆä¸ºä¸€åå¿—æ„¿è€…ã€‚", hint: "Role: volunteer." },
                { en: "It is important to help others.", cn: "å¸®åŠ©åˆ«äººæ˜¯å¾ˆé‡è¦çš„ã€‚", hint: "Start with 'It is important...'." },
                { en: "I picked up rubbish in the playground.", cn: "æˆ‘åœ¨æ“åœºä¸Šæ¡äº†åžƒåœ¾ã€‚", hint: "Past tense of 'pick'." },
                { en: "Can you help get the balloons?", cn: "ä½ èƒ½å¸®å¿™æ‹¿æ°”çƒå—ï¼Ÿ", hint: "Object: balloons." },
                { en: "The elderly man needs our help.", cn: "é‚£ä½è€äººéœ€è¦æˆ‘ä»¬çš„å¸®åŠ©ã€‚", hint: "Person: The elderly man." },
                { en: "We can make a difference together.", cn: "æˆ‘ä»¬å¯ä»¥ä¸€èµ·åšå‡ºæ”¹å˜ã€‚", hint: "Phrase: make a difference." }
            ]
        },
        {
            id: 'c2',
            title: 'The Real Winner',
            icon: 'ðŸ†',
            sentences: [
                { en: "The four friends went hiking yesterday.", cn: "æ˜¨å¤©é‚£å››ä¸ªæœ‹å‹åŽ»å¾’æ­¥æ—…è¡Œäº†ã€‚", hint: "Past tense of 'go'." },
                { en: "Let us have a race to the top.", cn: "è®©æˆ‘ä»¬æ¯”èµ›çˆ¬åˆ°å±±é¡¶å§ã€‚", hint: "Destination: to the top." },
                { en: "They all hurried up the hill.", cn: "ä»–ä»¬éƒ½èµ¶ç´§å¾€å±±ä¸Šçˆ¬ã€‚", hint: "Action: hurried up." },
                { en: "Daming was in the front at first.", cn: "å¤§æ˜Žèµ·åˆåœ¨æœ€å‰é¢ã€‚", hint: "Position: in the front." },
                { en: "Then he slowed down along the way.", cn: "ç„¶åŽä»–åœ¨åŠè·¯æ…¢äº†ä¸‹æ¥ã€‚", hint: "Action: slowed down." },
                { en: "He saw some cans and plastic bottles.", cn: "ä»–çœ‹åˆ°äº†ä¸€äº›ç½å­å’Œå¡‘æ–™ç“¶ã€‚", hint: "Items: cans and plastic bottles." },
                { en: "I picked them up and put them in a bag.", cn: "æˆ‘æŠŠå®ƒä»¬æ¡èµ·æ¥æ”¾è¿›è¢‹å­é‡Œã€‚", hint: "Action sequence: picked... put..." },
                { en: "My friends waited for me for a long time.", cn: "æˆ‘çš„æœ‹å‹ä»¬ç­‰äº†æˆ‘å¾ˆä¹…ã€‚", hint: "Duration: for a long time." },
                { en: "You are the real winner today.", cn: "ä½ ä»Šå¤©æ‰æ˜¯çœŸæ­£çš„èµ¢å®¶ã€‚", hint: "Person: real winner." },
                { en: "I was tired but very happy.", cn: "æˆ‘å¾ˆç´¯ä½†æ˜¯å¾ˆå¼€å¿ƒã€‚", hint: "Feeling: tired but happy." }
            ]
        },
        {
            id: 'c3',
            title: 'Sharing & Caring',
            icon: 'ðŸ¥ª',
            sentences: [
                { en: "The puppy is small and playful.", cn: "è¿™åªå°ç‹—åˆå°åˆçˆ±çŽ©ã€‚", hint: "Description: small and playful." },
                { en: "He will be someone's eyes one day.", cn: "æ€»æœ‰ä¸€å¤©ä»–ä¼šæˆä¸ºæŸäººçš„çœ¼ç›ã€‚", hint: "Future tense: will be." },
                { en: "He had no family and was eighty.", cn: "ä»–å…«åå²äº†ï¼Œæ²¡æœ‰å®¶äººã€‚", hint: "Age: eighty." },
                { en: "We played the ukulele and guitar together.", cn: "æˆ‘ä»¬ä¸€èµ·å¼¹å°¤å…‹é‡Œé‡Œå’Œå‰ä»–ã€‚", hint: "Instruments: ukulele and guitar." },
                { en: "She sat all alone at lunchtime.", cn: "åˆé¤æ—¶é—´å¥¹ç‹¬è‡ªåç€ã€‚", hint: "Time: at lunchtime." },
                { en: "I gave her half of my sandwich.", cn: "æˆ‘ç»™äº†å¥¹ä¸€åŠæˆ‘çš„ä¸‰æ˜Žæ²»ã€‚", hint: "Quantity: half of..." },
                { en: "I felt full after I ate it.", cn: "åƒå®ŒåŽæˆ‘è§‰å¾—å¾ˆé¥±ã€‚", hint: "Feeling: full." },
                { en: "It is good to share with friends.", cn: "å’Œæœ‹å‹åˆ†äº«æ˜¯å¾ˆå¥½çš„ã€‚", hint: "Action: share." },
                { en: "We are not good enough for a band.", cn: "æˆ‘ä»¬è¦ç»„ä¹é˜Ÿè¿˜ä¸å¤Ÿå¥½ã€‚", hint: "Group: band." },
                { en: "Making a new friend is wonderful.", cn: "ç»“äº¤æ–°æœ‹å‹çœŸæ˜¯å¤ªå¥½äº†ã€‚", hint: "Subject: Making a new friend." }
            ]
        },
        {
            id: 'c4',
            title: 'My Hero',
            icon: 'ðŸ¦¸',
            sentences: [
                { en: "Who is the hero in your heart?", cn: "è°æ˜¯ä½ å¿ƒä¸­çš„è‹±é›„ï¼Ÿ", hint: "Location: in your heart." },
                { en: "He had no magic at all.", cn: "ä»–æ ¹æœ¬æ²¡æœ‰é­”æ³•ã€‚", hint: "Possession: no magic." },
                { en: "He wanted to help one and all.", cn: "ä»–æƒ³å¸®åŠ©æ¯ä¸€ä¸ªäººã€‚", hint: "Phrase: one and all." },
                { en: "He was like a shining star.", cn: "ä»–åƒä¸€é¢—é—ªäº®çš„æ˜Ÿæ˜Ÿã€‚", hint: "Description: shining star." },
                { en: "He inspires us to do our part.", cn: "ä»–æ¿€åŠ±æˆ‘ä»¬å°½è‡ªå·±çš„ä¸€ä»½åŠ›ã€‚", hint: "Verb: inspires." },
                { en: "Lei Feng is my hero forever.", cn: "é›·é”‹æ°¸è¿œæ˜¯æˆ‘çš„è‹±é›„ã€‚", hint: "Time: forever." },
                { en: "We should learn from his spirit.", cn: "æˆ‘ä»¬è¦å­¦ä¹ ä»–çš„ç²¾ç¥žã€‚", hint: "Quality: spirit." },
                { en: "His stories moved me a lot.", cn: "ä»–çš„æ•…äº‹æ·±æ·±åœ°æ„ŸåŠ¨äº†æˆ‘ã€‚", hint: "Verb: moved." },
                { en: "I shared the stories with my son.", cn: "æˆ‘å’Œæˆ‘çš„å„¿å­åˆ†äº«äº†è¿™äº›æ•…äº‹ã€‚", hint: "Action: shared." },
                { en: "Kindness gives us great power.", cn: "å–„è‰¯ç»™äº†æˆ‘ä»¬å·¨å¤§çš„åŠ›é‡ã€‚", hint: "Subject: Kindness." }
            ]
        },
        {
            id: 'c5',
            title: 'Volunteer Spirit',
            icon: 'â¤ï¸',
            sentences: [
                { en: "We can clean up a park on Sunday.", cn: "æˆ‘ä»¬å¯ä»¥åœ¨å‘¨æ—¥æ‰“æ‰«å…¬å›­ã€‚", hint: "Action: clean up." },
                { en: "We can help at a care home.", cn: "æˆ‘ä»¬å¯ä»¥åœ¨å…»è€é™¢å¸®å¿™ã€‚", hint: "Place: care home." },
                { en: "We can give books to the children.", cn: "æˆ‘ä»¬å¯ä»¥æŠŠä¹¦é€ç»™å­©å­ä»¬ã€‚", hint: "Object: books." },
                { en: "Who will you go with tomorrow?", cn: "ä½ æ˜Žå¤©è¦å’Œè°ä¸€èµ·åŽ»ï¼Ÿ", hint: "Question word: Who." },
                { en: "What did you learn from it?", cn: "ä½ ä»Žä¸­å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ", hint: "Past tense question." },
                { en: "Non-profit organisations help people.", cn: "éžè¥åˆ©ç»„ç»‡å¸®åŠ©äººä»¬ã€‚", hint: "Subject: Non-profit organisations." },
                { en: "They protect animals and nature.", cn: "ä»–ä»¬ä¿æŠ¤åŠ¨ç‰©å’Œè‡ªç„¶ã€‚", hint: "Objects: animals and nature." },
                { en: "It works for world peace and education.", cn: "å®ƒè‡´åŠ›äºŽä¸–ç•Œå’Œå¹³ä¸Žæ•™è‚²ã€‚", hint: "Goal: peace and education." },
                { en: "How can we get involved?", cn: "æˆ‘ä»¬å¦‚ä½•å‚ä¸Žå…¶ä¸­ï¼Ÿ", hint: "Phrase: get involved." },
                { en: "Let us organise a volunteer activity.", cn: "è®©æˆ‘ä»¬ç»„ç»‡ä¸€æ¬¡å¿—æ„¿è€…æ´»åŠ¨ã€‚", hint: "Action: organise." }
            ]
        }
    ];

    /* --- LOGIC: Application --- */
    const app = {
        state: {
            currentChallenge: null,
            originalQueue: [],
            redemptionQueue: [],
            currentIndex: 0,
            score: 0,
            attempts: [], // {status: 'correct'|'hint'|'wrong'}
            isRedemption: false,
            userSelection: [],
            locked: false,
            hintUsed: false,
            currentTargetObj: null
        },

        init: function() {
            this.renderHome();
        },

        getLogs: function() {
            return JSON.parse(localStorage.getItem('sb_u2_logs') || '[]');
        },

        getMistakes: function() {
            return JSON.parse(localStorage.getItem('sb_u2_mistakes') || '[]');
        },

        saveLog: function(log) {
            const logs = this.getLogs();
            logs.unshift(log);
            localStorage.setItem('sb_u2_logs', JSON.stringify(logs));
        },

        saveMistake: function(targetEn, targetCn, challengeTitle, userAnswer) {
            const mistakes = this.getMistakes();
            const existingIndex = mistakes.findIndex(m => m.en === targetEn);
            if (existingIndex > -1) {
                const existing = mistakes[existingIndex];
                existing.count = (existing.count || 1) + 1;
                existing.date = new Date().toLocaleString();
                existing.user = userAnswer;
                mistakes.splice(existingIndex, 1);
                mistakes.unshift(existing);
            } else {
                mistakes.unshift({
                    date: new Date().toLocaleString(),
                    challenge: challengeTitle,
                    en: targetEn,
                    cn: targetCn,
                    user: userAnswer,
                    count: 1
                });
            }
            localStorage.setItem('sb_u2_mistakes', JSON.stringify(mistakes));
        },

        getChallengeStats: function(title) {
            const logs = this.getLogs();
            const now = new Date();
            const todayStr = now.toLocaleDateString();
            const todaysLogs = logs.filter(l => {
                if (l.challenge !== title) return false;
                return new Date(l.date).toLocaleDateString() === todayStr;
            });
            const attempts = todaysLogs.length;
            let maxScore = 0;
            if (attempts > 0) {
                maxScore = Math.max(...todaysLogs.map(l => parseInt(l.score)));
            }
            return { attempts, maxScore: attempts > 0 ? maxScore + '%' : '-' };
        },

        renderHome: function() {
            document.getElementById('home-screen').classList.add('active');
            document.getElementById('game-screen').classList.remove('active');
            
            const list = document.getElementById('challenge-list');
            list.innerHTML = '';

            challenges.forEach(c => {
                const stats = this.getChallengeStats(c.title);
                const card = document.createElement('div');
                card.className = 'challenge-card';
                card.onclick = () => this.startChallenge(c.id);
                card.innerHTML = `
                    <div style="display:flex; align-items:center">
                        <div class="challenge-icon">${c.icon}</div>
                        <div class="challenge-info">
                            <h3>${c.title}</h3>
                            <p>${c.sentences.length} sentences</p>
                            <p style="font-size:0.85rem; color:var(--primary-dark); font-weight:bold; margin-top:5px;">
                                Today: ${stats.attempts} runs | Best: ${stats.maxScore}
                            </p>
                        </div>
                    </div>
                    <div style="color:var(--secondary); font-weight:bold;">START</div>
                `;
                list.appendChild(card);
            });
        },

        startChallenge: function(id) {
            const challenge = challenges.find(c => c.id === id);
            this.state.currentChallenge = challenge;
            this.state.originalQueue = JSON.parse(JSON.stringify(challenge.sentences)); 
            this.state.redemptionQueue = [];
            this.state.currentIndex = 0;
            this.state.score = 0;
            this.state.isRedemption = false;
            this.state.attempts = new Array(challenge.sentences.length).fill(null);
            
            document.getElementById('home-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            
            this.renderProgressBar();
            this.loadQuestion();
        },

        renderProgressBar: function() {
            const bar = document.getElementById('progress-bar');
            bar.innerHTML = '';
            const total = this.state.originalQueue.length;
            
            for(let i=0; i<total; i++) {
                const segment = document.createElement('div');
                segment.className = 'progress-segment';
                if(this.state.attempts[i] === 'correct') segment.classList.add('green');
                if(this.state.attempts[i] === 'hint') segment.classList.add('yellow');
                if(this.state.attempts[i] === 'wrong') segment.classList.add('red');
                bar.appendChild(segment);
            }
        },

        loadQuestion: function() {
            let sentenceObj = null;
            if (this.state.currentIndex < this.state.originalQueue.length) {
                sentenceObj = this.state.originalQueue[this.state.currentIndex];
                this.state.isRedemption = false;
            } else if (this.state.redemptionQueue.length > 0) {
                sentenceObj = this.state.redemptionQueue.shift(); 
                this.state.isRedemption = true;
            } else {
                this.finishGame();
                return;
            }

            this.state.currentTargetObj = sentenceObj;
            this.state.locked = false;
            this.state.hintUsed = false;
            this.state.userSelection = [];

            // UI Resets
            document.getElementById('check-btn').style.display = 'block';
            document.getElementById('check-btn').disabled = true;
            document.getElementById('check-btn').className = 'check-btn';
            document.getElementById('check-btn').innerText = 'CHECK';
            
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('feedback-area').className = 'feedback';
            document.getElementById('hint-display').style.display = 'none';
            document.getElementById('hint-btn').disabled = false;
            
            // Sentence Setup
            document.getElementById('display-text').innerText = sentenceObj.cn;
            
            const cleanSentence = sentenceObj.en.replace(/[.!?]$/, ''); 
            let words = cleanSentence.split(' ');
            
            // Pool Generation: Lowercase first word if not "I" or name
            let poolWords = words.map((w, i) => {
                if (i === 0 && w !== "I" && w !== "Lei" && w !== "Feng" && w !== "Daming" && w !== "Sunday" && w !== "June") {
                    return w.toLowerCase();
                }
                return w;
            });

            // Noise
            for(let k=0; k<3; k++) {
                const r = noiseWords[Math.floor(Math.random() * noiseWords.length)];
                if(!poolWords.includes(r)) poolWords.push(r);
            }
            poolWords.sort(() => Math.random() - 0.5);

            const poolContainer = document.getElementById('word-pool');
            poolContainer.innerHTML = '';
            
            poolWords.forEach((w, idx) => {
                const btn = document.createElement('button');
                btn.className = 'word-btn';
                
                // IPA Lookup
                let displayWord = w;
                let cleanW = w.replace(/[.,?!]/g, ""); 
                // Handle cases where word might be Capitalized in dict (e.g., proper nouns) or lowercase
                let ipa = ipaDict[cleanW] || ipaDict[cleanW.toLowerCase()] || ipaDict[cleanW.charAt(0).toUpperCase() + cleanW.slice(1)] || "";
                
                btn.innerHTML = `<span>${w}</span><span class="ipa-text">${ipa ? '/' + ipa + '/' : ''}</span>`;
                
                btn.dataset.id = idx;
                btn.onclick = () => this.handleWordSelect(w, idx, btn);
                poolContainer.appendChild(btn);
            });

            this.renderAnswerArea();
        },

        showHint: function() {
            if(this.state.locked) return;
            this.state.hintUsed = true;
            const disp = document.getElementById('hint-display');
            disp.innerText = "Hint: " + this.state.currentTargetObj.hint;
            disp.style.display = 'block';
            document.getElementById('hint-btn').disabled = true;
        },

        handleWordSelect: function(word, id, btnElement) {
            if(this.state.locked) return;
            if(btnElement.classList.contains('selected')) return;

            this.state.userSelection.push({word: word, id: id});
            btnElement.classList.add('selected');
            this.renderAnswerArea();
            this.updateCheckButton();
        },

        removeWord: function(index) {
            if(this.state.locked) return;
            const removed = this.state.userSelection.splice(index, 1)[0];
            
            const poolBtns = document.querySelectorAll('.word-btn');
            poolBtns.forEach(btn => {
                if(btn.dataset.id == removed.id) {
                    btn.classList.remove('selected');
                }
            });
            this.renderAnswerArea();
            this.updateCheckButton();
        },

        renderAnswerArea: function() {
            const area = document.getElementById('answer-area');
            area.innerHTML = '';

            if (this.state.userSelection.length === 0) {
                area.innerHTML = '<div class="answer-placeholder">Tap words below to build sentence...</div>';
                return;
            }

            this.state.userSelection.forEach((item, idx) => {
                const btn = document.createElement('button');
                btn.className = 'word-btn-answer';
                
                // Auto Capitalize first word
                let displayText = item.word;
                if(idx === 0) {
                    displayText = displayText.charAt(0).toUpperCase() + displayText.slice(1);
                }

                btn.innerText = displayText; // No IPA in answer area
                btn.onclick = () => this.removeWord(idx);
                area.appendChild(btn);
            });
        },

        updateCheckButton: function() {
            document.getElementById('check-btn').disabled = this.state.userSelection.length === 0;
        },

        checkAnswer: function() {
            this.state.locked = true;
            const btn = document.getElementById('check-btn');
            const feedback = document.getElementById('feedback-area');
            const title = document.getElementById('feedback-title');
            const msg = document.getElementById('feedback-msg');

            let userSentence = "";
            this.state.userSelection.forEach((item, idx) => {
                let w = item.word;
                if(idx === 0) w = w.charAt(0).toUpperCase() + w.slice(1);
                userSentence += w + " ";
            });
            userSentence = userSentence.trim();

            const targetEn = this.state.currentTargetObj.en;
            const cleanTarget = targetEn.replace(/[.!?]$/, '');
            
            // Allow matching without punctuation strictness
            const isCorrect = userSentence.replace(/[.!?]/g, "") === cleanTarget.replace(/[.!?]/g, "");

            if(isCorrect) {
                if(this.state.hintUsed) {
                    btn.className = 'check-btn correct'; // Using correct style but score reflects partial
                    feedback.className = 'feedback show correct';
                    title.innerText = 'Good! (Hint used)';
                    msg.innerText = '';
                    if(!this.state.isRedemption) {
                        this.state.attempts[this.state.currentIndex] = 'hint';
                        this.state.score += 5;
                    }
                } else {
                    btn.className = 'check-btn correct';
                    feedback.className = 'feedback show correct';
                    title.innerText = 'Perfect!';
                    msg.innerText = '';
                    if(!this.state.isRedemption) {
                        this.state.attempts[this.state.currentIndex] = 'correct';
                        this.state.score += 10;
                    }
                }
            } else {
                btn.className = 'check-btn wrong';
                btn.innerText = 'Incorrect';
                feedback.className = 'feedback show wrong';
                title.innerText = 'Correct Answer:';
                msg.innerText = targetEn;

                this.saveMistake(targetEn, this.state.currentTargetObj.cn, this.state.currentChallenge.title, userSentence);

                if(!this.state.isRedemption) {
                    this.state.attempts[this.state.currentIndex] = 'wrong';
                    this.state.redemptionQueue.push(this.state.currentTargetObj);
                } else {
                    this.state.redemptionQueue.push(this.state.currentTargetObj);
                }
            }

            this.renderProgressBar();
            btn.style.display = 'none';
            document.getElementById('next-btn').style.display = 'block';
        },

        nextQuestion: function() {
            if (!this.state.isRedemption) {
                this.state.currentIndex++;
            }
            this.loadQuestion();
        },

        finishGame: function() {
            const maxScore = this.state.originalQueue.length * 10;
            const log = {
                date: new Date().toLocaleString(),
                challenge: this.state.currentChallenge.title,
                score: this.state.score + ' / ' + maxScore
            };
            this.saveLog(log);

            document.getElementById('game-screen').innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center;">
                    <h1 style="color:var(--primary); font-size:3rem;">Completed!</h1>
                    <h2>Score: ${this.state.score} / ${maxScore}</h2>
                    <div style="margin:20px 0;">
                        <button onclick="location.reload()" class="check-btn" style="width:200px;">Back to Home</button>
                    </div>
                </div>
            `;
        },

        goHome: function() {
            if(confirm("Exit this challenge? Progress will be lost.")) {
                this.renderHome();
            }
        },

        /* --- Admin --- */
        showHistory: function() {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            const logs = this.getLogs();

            if(logs.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">No sessions recorded.</p>';
            } else {
                logs.forEach(l => {
                    const div = document.createElement('div');
                    div.className = 'log-item';
                    div.innerHTML = `<strong>${l.challenge}</strong> <span class="score">${l.score}</span><br><span style="color:#999; font-size:0.8rem">${l.date}</span>`;
                    list.appendChild(div);
                });
            }
            modal.style.display = 'flex';
        },

        closeHistory: function() { document.getElementById('history-modal').style.display = 'none'; },

        showMistakes: function() {
            const modal = document.getElementById('mistakes-modal');
            const list = document.getElementById('mistakes-list');
            list.innerHTML = '';
            const mistakes = this.getMistakes();

            if(mistakes.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">No mistakes recorded yet.</p>';
            } else {
                mistakes.forEach(m => {
                    const count = m.count || 1;
                    const countBadge = count > 1 ? `<span style="background:var(--danger); color:white; padding:1px 6px; border-radius:10px; font-size:0.7rem; margin-left:5px;">x${count}</span>` : '';
                    const div = document.createElement('div');
                    div.className = 'log-item';
                    div.innerHTML = `
                        <div style="font-size:0.8rem; color:#999;">${m.date} - ${m.challenge}</div>
                        <div style="margin:5px 0;"><strong>Q:</strong> ${m.cn}${countBadge}</div>
                        <div style="color:var(--danger); text-decoration:line-through; font-size:0.9rem;">${m.user || '(No answer)'}</div>
                        <div style="color:var(--primary-dark); font-weight:bold; font-size:0.9rem;">${m.en}</div>
                    `;
                    list.appendChild(div);
                });
            }
            modal.style.display = 'flex';
        },

        closeMistakes: function() { document.getElementById('mistakes-modal').style.display = 'none'; },

        clearMistakes: function() {
            const input = prompt("Enter Teacher Passcode (Hint: First letters of the 5 Challenge Titles):");
            // Titles: Helping, Real, Sharing, My, Volunteer -> HTSMV
            if(input && input.toUpperCase() === 'HTSMV') {
                localStorage.removeItem('sb_u2_mistakes');
                this.showMistakes();
            } else if (input) {
                alert("Incorrect passcode.");
            }
        },

        clearHistory: function() {
            const input = prompt("Enter Teacher Passcode:");
            if(input && input.toUpperCase() === 'HTSMV') {
                localStorage.removeItem('sb_u2_logs');
                this.showHistory();
            } else if (input) {
                alert("Incorrect passcode.");
            }
        }
    };

    window.onload = function() { app.init(); };

</script>
</body>
</html>